{% load i18n %}
{% load permission %}
{#<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"#}
{#        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">#}
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>{% trans "VRV Cloud" %}</title>
<link href="{{ STATIC_URL }}ui/images/favicon.ico" rel="shortcut icon"
      type="image/x-icon"/>
<link href="{{ STATIC_URL }}ui/themes/default/style.css" rel="stylesheet"
      type="text/css" media="screen"/>
<link href="{{ STATIC_URL }}ui/themes/css/core.css" rel="stylesheet"
      type="text/css" media="screen"/>
<link href="{{ STATIC_URL }}ui/themes/css/print.css" rel="stylesheet"
      type="text/css" media="print"/>
<link href="{{ STATIC_URL }}ui/uploadify/css/uploadify.css" rel="stylesheet"
      type="text/css" media="screen"/>
<link href="{{ STATIC_URL }}ui/themes/css/index.css" rel="stylesheet"
      type="text/css" media="screen"/>
<link href="{{ STATIC_URL }}ui/themes/css/monitor.css" rel="stylesheet"
      type="text/css" media="screen"/>
<link href="{{ STATIC_URL }}ui/themes/css/jquery.wijmo.css" rel="stylesheet"
      type="text/css" media="screen"/>
<link href="{{ STATIC_URL }}ui/themes/css/jquery.jgrowl.css" rel="stylesheet"
      type="text/css" media="screen"/>
<link href="{{ STATIC_URL }}ui/themes/css/creeper.css" rel="stylesheet"
      type="text/css" media="screen"/>
<!--[if IE]>
    <link href=".{{ STATIC_URL }}ui/themes/css/ieHack.css" rel="stylesheet" type="text/css" media="screen"/>
    <![endif]-->
<link href="{{ STATIC_URL }}ui/datepicker/themes/base/jquery.ui.all.css"
      rel="stylesheet">

<script src="{{ STATIC_URL }}ui/js/speedup.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/jquery.1.7.2.min.js"
        type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/jquery-ui.min.js"
        type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/jquery.jgrowl.min.js"
        type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/jquery.wijmo.min.js"
        type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/jquery.cookie.min.js"
        type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/jquery.validate.min.js"
        type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/jquery.bgiframe.min.js"
        type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/xheditor/xheditor-1.1.14-zh-cn.min.js"
        type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/uploadify/scripts/swfobject.min.js"
        type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/uploadify/scripts/jquery.uploadify.v2.1.0.min.js"
        type="text/javascript"></script>
<script type="text/javascript"
        src="{{ STATIC_URL }}ui/chart/highcharts.src.min.js"></script>
<script type="text/javascript"
        src="{{ STATIC_URL }}ui/chart/exporting.src.min.js"></script>
<script src="{{ STATIC_URL }}ui/js/common.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/core.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/util.date.min.js"
        type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/validate.method.min.js"
        type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/barDrag.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/drag.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/tree.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/accordion.min.js"
        type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/ui.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/theme.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/switchEnv.min.js"
        type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/alertMsg.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/contextmenu.min.js"
        type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/navTab.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/tab.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/resize.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/dialog.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/dialogDrag.min.js"
        type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/sortDrag.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/cssTable.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/stable.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/taskBar.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/ajax.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/pagination.min.js"
        type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/database.min.js" type="text/javascript"></script>
{#<script src="{{ STATIC_URL }}ui/js/datepicker.js" type="text/javascript"></script>#}
<script src="{{ STATIC_URL }}ui/js/effects.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/panel.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/checkbox.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/history.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/combox.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/print.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/js/horizon.min.js"></script>
<script src="{{ STATIC_URL }}ui/js/horizon.quota.min.js"></script>
<script src="{{ STATIC_URL }}ui/js/spin.jquery.min.js"></script>
<script src="{{ STATIC_URL }}ui/js/spin.min.js"></script>
<script src="{{ STATIC_URL }}ui/js/creeper.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}ui/js/util.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}ui/js/base64.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}ui/js/websock.min.js"></script>
<!--
    <script src="{{ STATIC_URL }}ui/bin/min.js" type="text/javascript"></script>
    -->
{% if language %}
    <script src="{{ STATIC_URL }}ui/js/regional.zh.min.js"
            type="text/javascript"></script>
{% endif %}
<script src="{{ STATIC_URL }}ui/js/timer.task.min.js"
        type="text/javascript"></script>
<script src="{{ STATIC_URL }}ui/datepicker/ui/jquery.ui.core.min.js"></script>
<script src="{{ STATIC_URL }}ui/datepicker/ui/jquery.ui.widget.min.js"></script>
<script src="{{ STATIC_URL }}ui/datepicker/ui/jquery.ui.datepicker.min.js"></script>
<link href="{{ STATIC_URL }}ui/themes/css/datepicker.css" rel="stylesheet"
      type="text/css"/>

<script type="text/javascript"
        src="{{ STATIC_URL }}ui/easy/html5shiv.min.js"></script>
<script type="text/javascript"
        src="{{ STATIC_URL }}ui/easy/excanvas.min.js"></script>
<script type="text/javascript"
        src="{{ STATIC_URL }}ui/easy/jquery.easy-pie-chart.min.js"></script>
<link rel="stylesheet" type="text/css"
      href="{{ STATIC_URL }}ui/easy/jquery.easy-pie-chart.css" media="screen">
<script type="text/javascript">

    (function ($) {
        $.fn.extend({
            Scroll:function (opt, callback) {
                //参数初始化
                if (!opt) var opt = {};
                var _btnUp = $("#" + opt.up); //Shawphy:向上按钮
                var _btnDown = $("#" + opt.down); //Shawphy:向下按钮
                var timerID;
                var _this = this.eq(0).find("ul:first");
                var lineH = _this.find("li:first").height(), //获取行高
                        line = opt.line ? parseInt(opt.line, 10) : parseInt(this.height() / lineH, 10), //每次滚动的行数，默认为一屏，即父容器高度
                        speed = opt.speed ? parseInt(opt.speed, 10) : 3000; //卷动速度，数值越大，速度越慢（毫秒）
                timer = opt.timer ? parseInt(opt.timer, 10) : 3000; //滚动的时间间隔（毫秒）
                if (line == 0) line = 1;
                var upHeight = 0 - line * lineH;
                //滚动函数
                var scrollUp = function () {
                    _btnUp.unbind("click", scrollUp); //Shawphy:取消向上按钮的函数绑定
                    _this.animate({
                        marginTop:upHeight
                    }, speed, function () {
                        for (i = 1; i <= line; i++) {
                            _this.find("li:first").appendTo(_this);
                        }
                        _this.css({ marginTop:0 });
                        _btnUp.bind("click", scrollUp); //Shawphy:绑定向上按钮的点击事件
                    });
                }
                //Shawphy:向下翻页函数
                var scrollDown = function () {
                    _btnDown.unbind("click", scrollDown);
                    for (i = 1; i <= line; i++) {
                        _this.find("li:last").show().prependTo(_this);
                    }
                    _this.css({ marginTop:upHeight });
                    _this.animate({
                        marginTop:0
                    }, speed, function () {
                        _btnDown.bind("click", scrollDown);
                    });
                }
                //Shawphy:自动播放
                var autoPlay = function () {
                    if (timer) timerID = window.setInterval(scrollUp, timer);
                };
                var autoStop = function () {
                    if (timer) window.clearInterval(timerID);
                };
                onclick = "sssssasss(this)"
                //鼠标事件绑定
                _this.hover(autoStop, autoPlay).mouseout();
                _btnUp.css("cursor", "pointer").click(scrollUp).hover(autoStop, autoPlay); //Shawphy:向上向下鼠标事件绑定
                _btnDown.css("cursor", "pointer").click(scrollDown).hover(autoStop, autoPlay);
            }
        })
    })(jQuery);

    var global_ws = null;
    $(function () {
        var test = "dwz.frag.ch.xml"
        var language = '{{language}}';
        if (language == 'False') {
            test = "dwz.frag.en.xml"
        }

        if($("#navigation li").length == 0){
	        $("#navigation").hide();
        }
{#        if($("#navigation li").length == 0 && $("#notice").html() == null){#}
{#	        $("#no_nav").remove()#}
{#        }#}
        DWZ.init("{{ STATIC_URL }}ui/" + test, {
            loginUrl:"login_dialog.html", loginTitle:"登录", // 弹出登录对话框
            statusCode:{ ok:200, error:300, timeout:301 }, //【可选】
            pageInfo:{ pageNum:"pageNum", numPerPage:"numPerPage", orderField:"orderField", orderDirection:"orderDirection" }, //【可选】
            debug:false, // 调试模式 【true|false】
            callback:function () {
                Timer.initialize({period: {{ AJAX_HOST_STATUS_TIME }} });
                initEnv();
                $("#themeList").theme({ themeBase:"themes" }); // themeBase 相对于index页面的主题base路径
            }
        });

        // INIT HOMEPAGE UI
        indexFun();
        //getlist();
        if($("#project_info")){
            gain_organization_group_info();
        }
        {% permission 'View Node' %}
        if($(".hardware").length != 0){
            get_hardware_info();
            get_ip_info();
            initPieChart();
        }
        {% endpermission %}
        {% permission 'View Global Monitor' %}
        if($(".facility").length != 0){
            get_facility_info();

            // INIT TIMER
            var navTabId = "{% trans 'homepage' %}";
            //,{period:10000}
            Timer.submit(navTabId, get_facility_info);
        }
        {% endpermission %}
        refresh_index_notice();
        $("#scrollDiv").Scroll({ line:1, speed:500, timer:3000, up:"btn1", down:"btn2" });
        $("#datepicker").datepicker({
            monthNames:['{% trans "Jan" %}', '{% trans "Feb" %}', '{% trans "Mar" %}', '{% trans "Apr" %}', '{% trans "May" %}', '{% trans "Jun" %}', '{% trans "Jul" %}', '{% trans "Aug" %}', '{% trans "Sep" %}', '{% trans "Oct" %}', '{% trans "Nov" %}', '{% trans "Dec" %}'],
            monthNamesShort:['{% trans "Jan" %}', '{% trans "Feb" %}', '{% trans "Mar" %}', '{% trans "Apr" %}', '{% trans "May" %}', '{% trans "Jun" %}', '{% trans "Jul" %}', '{% trans "Aug" %}', '{% trans "Sep" %}', '{% trans "Oct" %}', '{% trans "NOv" %}', '{% trans "Dec" %}'],
            dayNames:['{% trans "Su" %}', '{% trans "Mo" %}', '{% trans "Tu" %}', '{% trans "We" %}', '{% trans "Th" %}', '{% trans "Fr" %}', '{% trans "Sa" %}'],
            dayNamesMin:['{% trans "Sun" %}', '{% trans "Mon" %}', '{% trans "Tue" %}', '{% trans "Wed" %}', '{% trans "Thu" %}', '{% trans "Fri" %}', '{% trans "Sat" %}']
        });
        $("#datepicker").datepicker($.datepicker.regional['zh-CN']);

        if($("#log_list_home")){
            get_log_list();
        }

        var navTabId = "{% trans 'Notice' %}";
        Timer.submit(navTabId,refresh_index_notice);
{#        get_prepare_list();#}
{#        prepare_list_info();#}

        get_user_task_list();

        var navTabId = "{% trans 'Check Manage' %}";
        Timer.submit(navTabId,get_user_task_list);
{#        Timer.submit(navTabId, prepare_list_info);#}
    });
</script>

<script language="javascript" type="text/javascript">

function get_log_list() {
    $.ajax({
        url:"{% url 'log_query_home_page' %}",
        type:'GET',
        global:false,
        success:function (htmlData) {
            $("#log_list_home").html(htmlData).initUI();
        }
    });
}

{#function get_prepare_list() {#}
{#    $.ajax({#}
{#        url:"{% url 'get_prepare_list' %}",#}
{#        type:'GET',#}
{#        global:false,#}
{#        success:function (htmlData) {#}
{#            $("#prepare_list_id").html(htmlData).initUI();#}
{#        }#}
{#    });#}
{#}#}

function get_user_task_list() {
    $.ajax({
               url:"{% url 'get_user_task_list' %}",
               type:'GET',
               global:false,
               success:function (htmlData) {
                   $("#task_list_id").html(htmlData).initUI();
               }
           });
}
function get_hardware_info() {
    var vcpus_per = 0;
    var memory_mb_per = 0;
    var local_gb_per = 0;
    var ip_per = 0;
    $.ajax({
        type:"GET",
        url:"{% url "get_hardware_info" %}",
        dataType:"json",
        global:false,
        async:false,
        success:function (data) {
            if (data != "Not Found") {
                vcpus_per = data["vcpus_per"];
                $(".index_content #vcpus_per").attr("data-percent", vcpus_per);
                memory_mb_per = data["memory_mb_per"];
                $(".index_content #memory_mb_per").attr("data-percent", memory_mb_per);
                local_gb_per = data["local_gb_per"];
                $(".index_content #local_gb_per").attr("data-percent", local_gb_per);
            }
        },
        error:function (xhr, ajaxOptions, thrownError) {
            DWZ.ajaxError(xhr, ajaxOptions, thrownError);
        }
    });
}
function get_ip_info() {
    $.ajax({
        type:"GET",
        url:"{% url "get_floatingip_count_info" %}",
        dataType:"json",
        global:false,
        async:false,
        success:function (data) {
            if (data != "Not Found") {
                $(".index_content #ip_per").attr("data-percent", data["vip_per"]);
            }
        },
        error:function (xhr, ajaxOptions, thrownError) {
            DWZ.ajaxError(xhr, ajaxOptions, thrownError);
        }
    });
}
function get_facility_info() {
    var instance_name1 = "";
    var memory_mb_per = 0;
    var instance_online = "";
    var instance_offline = "";
    var host_type = "";
    var host_state = "";
    var cpu_use = "";
    var obj = "";
    $(".part ~ div").css("display", "none");
    $.ajax({
               type:"GET",
               url:"{% url "get_facility_info" %}",
               dataType:"json",
               global:false,
               async:false,
               success:function (data) {
                   $.each(
                           data, function (i, item) {
                               instance_name1 = item["instance_name"];
                               memory_mb_per = item["memory_mb_per"];
                               instance_online = item["instance_online"];
                               instance_offline = item["instance_offline"];
                               host_type = item["host_type"];
                               host_state = item['host_state'];
                               cpu_use = item["cpu_use"];
                               obj = ".index_content #facility" + i;
                               $(obj).css('display', '');
                               $(obj + " .instance_name").html(instance_name1);
                               $(obj + " .memory_line .inner_line").css("width", memory_mb_per + "%");
                               $(obj + " .memory_line .per").html(memory_mb_per + "%");
                               $(obj + " .instance_online").html(instance_online);
                               $(obj + " .instance_offline").html(instance_offline);
                               $(obj + " .controll_node").html(host_type);
                               $(obj + " .instance_status").html(host_state);
                               $(obj + " .cpu_line .inner_line").css("width", cpu_use + "%");
                               $(obj + " .cpu_line .per").html(cpu_use + "%");
                               if (host_state == '{% trans 'online' %}') {
                               {#                                    $("#facility" + i+" > .title > div:eq(1) >div:eq(1)").removeClass();#}
                               {#                                   $("#facility" + i+" > .title > div:eq(1) >div:eq(1)").addClass("state");#}
                                   $("#titImg" + i).removeClass();
                                   $("#titImg" + i).addClass("state");
                               } else {
                                   $("#titImg" + i).removeClass();
                                   $("#titImg" + i).addClass("unstate");
                               }
                           }
                   );

               },
               error:function (xhr, ajaxOptions, thrownError) {
                   //DWZ.ajaxError(xhr, ajaxOptions, thrownError);
               }
           });

}

function prepare_list_info() {
    $.ajax({
        type:"GET",
        url:"{% url "prepare_list_info" %}",
        dataType:"json",
        global:false,
        async:false,
        success:function (data) {
            if (data != "Not Found") {
{#                get_prepare_list();#}
            }
        },
        error:function (xhr, ajaxOptions, thrownError) {
            //DWZ.ajaxError(xhr, ajaxOptions, thrownError);
        }
    });

}

function getlist() {
    $.ajax({
        type:"GET",
        url:"{% url "get_controller_menu" %}",
        dataType:"json",
        async:false,
        success:function (data) {
            var result = $("#result");
            $.each(data, function (i, item) {
                if (item.parent_id == "-1") {
                    var content = "<div class='accordionHeader' id=\"" + item.id + "_header\"><h2><span>Folder</span>" + item.label_name + "</h2></div>";
                    content += "<div class='accordionContent'><ul id='" + item.id + "' class='tree'></ul></div>";
                    result.append(content);
                }
                else {
                    var parentDiv = $("#" + item.parent_id + "_header");
                    var content = "<li>" + "<a href=" + "'" + item.action_name + "'" + "target=navTab" + " rel='" + item.label_name + "'>" + item.label_name + "</a></li>";
                    var origion_html = $("#" + item.parent_id + "").html();
                    $("#" + item.parent_id + "").html(origion_html + content);
                }
            });
        },
        error:function () {
            alert("菜单列表数据获取失败");
        }
    });
}
function refresh_index_notice() {
    var notice_url = "{% url "detail_notice_for_head" "#notice_uuid#" %}";
    var noticesData = "";
    var uuid = "";
    var title = "";
    var href_url = ""
    $.ajax({
        type:"GET",
        url:"{% url "get_notices" %}",
        dataType:"json",
        global:false,
        async:false,
        success:function (data) {
            $.each(
                    data, function (i, item) {
                        uuid = item["uuid"];
                        title = item["title"];
                        href_url = notice_url.replace('#notice_uuid#', uuid);
                        noticesData = noticesData + "<li><a target=\"dialog\" href=\"" + href_url + "\" tmask=\"true\" width=\"800\" height=\"500\">" + title + "</a></li>";
                    }
            );
        }
    });
    $("#index_notices_id").html(noticesData).initUI();
}

function gain_organization_group_info() {
    var htmlData = "";
    $.ajax({
        type:"GET",
        url:"{% url "get_project_summary" %}",
        dataType:"json",
        global:false,
        success:function (data) {
            $.each(data, function (i, item) {
                htmlData += "<div class=\"td\" style=\"width:18.4%;\">" + item['project_name'] + "</div>";
                htmlData += "<div class=\"td\" style=\"width:10.7%;\">" + item['user_cnt'] + "</div>";
                htmlData += "<div class=\"td\" style=\"width:10.3%;\">" + item['network_cnt'] + "</div>";
                htmlData += "<div class=\"td\" style=\"width:29.7%;\">" + item['instance_on_cnt'] + "</div>";
                htmlData += "<div class=\"td\" style=\"width:30.9%;\">" + item['instance_off_cnt'] + "</div>";
            });
            $("#project_info").html(htmlData).initUI();
        }
    });
}

function indexFun() {
    var window_width = $(window).width();
    var sidebar_width = $("#sidebar").width();
    var index_width = $(".index_content").width();
    var right_width = $(".index_content .right").width();
    var width = 0;
    if ((window_width - sidebar_width - 32) > index_width) {
        width = window_width - sidebar_width - right_width - 37;
        $(".index_content .left").width(width + "px");
    }
    var left_width = $(".index_content .left").width();
    width = (left_width - 9) / 2;
    $(".index_content .left .event").width(width + "px");
    width = width - 17;

    var $index_project=$(".index_content #index_project .tr");

    if($index_project){
        $index_project.width(width + "px");
        $index_project.css("padding-left", "9px");
        $index_project.css("padding-right", "8px");
        $index_project.css("text-align", "center");
    }

    width = left_width - 2;
    var $hardware=$(".index_content .left .hardware");
    if($hardware){
        $hardware.width(width + "px");
        var ring_width=$hardware.find(".ring").width();
        var diffw = (width - ring_width * 4) / 5;
        $hardware.find(".ring").css("margin-left", diffw);
    }

    var $facility=$(".index_content .left .facility");

    if($facility){
        $facility.width(width + "px");
        var $part=$facility.find(".part");
        var facility_part_width = $part.width();
        diffw = (width - (facility_part_width + 2) * 4) / 5;
        $part.css("margin-left", diffw);
    }
}

var initPieChart = function () {
    $('.percentage-light').easyPieChart({
        barColor:function (percent) {
            if (percent > 50) {
                return '#E64C65';
            } else {
                return '#4FC4F6';
            }
        },
        trackColor:'#11a4ab',
        scaleColor:false,
        lineCap:'butt',
        rotate:-90,
        lineWidth:20,
        animate:1000,
        size:130,
        onStep:function (value) {
            this.$el.find('span').text(~~value + '%');
        }
    });
};
</script>
