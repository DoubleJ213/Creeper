if(window.WebSocket&&!window.WEB_SOCKET_FORCE_FLASH){Websock_native=true}else{if(window.MozWebSocket&&!window.WEB_SOCKET_FORCE_FLASH){Websock_native=true;window.WebSocket=window.MozWebSocket}else{Websock_native=false;try{(function(){window.WEB_SOCKET_SWF_LOCATION=Util.get_include_uri()+"web-socket-js/WebSocketMain.swf";if(Util.Engine.trident){Util.Debug("Forcing uncached load of WebSocketMain.swf");window.WEB_SOCKET_SWF_LOCATION+="?"+Math.random()}Util.load_scripts(["web-socket-js/swfobject.js","web-socket-js/web_socket.js"])}())}catch(excp){alertMsg("请安装Adobe Flash Player")}}}function Websock(){var C={},U=null,I="base64",V=[],L=0,H=10000,W=[],e={"message":function(){},"open":function(){},"close":function(){},"error":function(){}},f=false;function D(){return W}function E(){return V}function Q(){return L}function F(j){L=j}function P(){return V.length-L}function i(){return(V[L])}function O(){return(V[L++])}function G(j){if(L===0){V.unshift(j)}else{L-=1;V[L]=j}}function J(){return(V[L++]<<8)+(V[L++])}function b(){return(V[L++]<<24)+(V[L++]<<16)+(V[L++]<<8)+(V[L++])}function d(j){if(typeof(j)==="undefined"){j=P()}var k=V.slice(L,L+j);L+=j;return String.fromCharCode.apply(null,k)}function N(j){if(typeof(j)==="undefined"){j=P()}L+=j;return V.slice(L-j,L)}function M(k,j){if(j){return V.slice(L+k,L+j)}else{return V.slice(L+k)}}function h(m,k,l){var j=V.length-L;if(j<k){if(l){if(L<l){throw ("rQwait cannot backup "+l+" bytes")}L-=l}return true}return false}function S(){if(I==="binary"){return(new Uint8Array(W)).buffer}else{return Base64.encode(W)}}function c(l){if(I==="binary"){var k=new Uint8Array(l);for(var j=0;j<k.length;j++){V.push(k[j])}}else{V=V.concat(Base64.decode(l,0))}}function T(){if(U.bufferedAmount!==0){Util.Debug("bufferedAmount: "+U.bufferedAmount)}if(U.bufferedAmount<C.maxBufferedAmount){if(W.length>0){U.send(S(W));W=[]}return true}else{Util.Info("Delaying send, bufferedAmount: "+U.bufferedAmount);return false}}function a(j){W=W.concat(j);return T()}function B(j){C.send(j.split("").map(function(k){return k.charCodeAt(0)}))}function Y(j){try{c(j.data);if(P()>0){e.message();if(V.length>H){V=V.slice(L);L=0}}else{Util.Debug("Ignoring empty message")}}catch(k){if(typeof k.stack!=="undefined"){Util.Warn("recv_message, caught exception: "+k.stack)}else{if(typeof k.description!=="undefined"){Util.Warn("recv_message, caught exception: "+k.description)}else{Util.Warn("recv_message, caught exception:"+k)}}if(typeof k.name!=="undefined"){e.error(k.name+": "+k.message)}else{e.error(k)}}}function Z(j,k){e[j]=k}function X(l){V=[];L=0;W=[];U=null;var m=false,o=false,p=false;if(("Uint8Array" in window)&&("set" in Uint8Array.prototype)){m=true}try{if(m&&("binaryType" in (new WebSocket("ws://localhost:17523")))){Util.Info("Detected binaryType support in WebSockets");o=true}}catch(n){}if(typeof(l)==="undefined"){if(o){l=["binary","base64"]}else{l="base64"}}if(!o){if(l==="binary"){throw ("WebSocket binary sub-protocol requested but not supported")}if(typeof(l)==="object"){var k=[];for(var j=0;j<l.length;j++){if(l[j]==="binary"){Util.Error("Skipping unsupported WebSocket binary sub-protocol")}else{k.push(l[j])}}if(k.length>0){l=k}else{throw ("Only WebSocket binary sub-protocol was requested and not supported.")}}}return l}function A(k,j){j=X(j);if(f){U={}}else{U=new WebSocket(k,j);if(j.indexOf("binary")>=0){U.binaryType="arraybuffer"}}U.onmessage=Y;U.onopen=function(){Util.Debug(">> WebSock.onopen");if(U.protocol){I=U.protocol;Util.Info("Server chose sub-protocol: "+U.protocol)}else{I="base64";Util.Error("Server select no sub-protocol!: "+U.protocol)}e.open();Util.Debug("<< WebSock.onopen")};U.onclose=function(l){Util.Debug(">> WebSock.onclose");e.close(l);Util.Debug("<< WebSock.onclose")};U.onerror=function(l){Util.Debug(">> WebSock.onerror: "+l);e.error(l);Util.Debug("<< WebSock.onerror")}}function K(){if(U){if((U.readyState===WebSocket.OPEN)||(U.readyState===WebSocket.CONNECTING)){Util.Info("Closing WebSocket connection");U.close()}U.onmessage=function(j){return}}}function R(k,j){f=true;I=j;C.send=k;C.close=function(){};return Y}function g(){C.maxBufferedAmount=200;C.get_sQ=D;C.get_rQ=E;C.get_rQi=Q;C.set_rQi=F;C.rQlen=P;C.rQpeek8=i;C.rQshift8=O;C.rQunshift8=G;C.rQshift16=J;C.rQshift32=b;C.rQshiftStr=d;C.rQshiftBytes=N;C.rQslice=M;C.rQwait=h;C.flush=T;C.send=a;C.send_string=B;C.on=Z;C.init=X;C.open=A;C.close=K;C.testMode=R;return C}return g()};