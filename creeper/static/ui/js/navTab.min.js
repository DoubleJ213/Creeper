var navTab={componentBox:null,_tabBox:null,_prevBut:null,_nextBut:null,_panelBox:null,_moreBut:null,_moreBox:null,_currentIndex:0,_op:{id:"navTab",stTabBox:".navTab-tab",stPanelBox:".navTab-panel",mainTabId:"main",close$:"a.close",prevClass:"tabsLeft",nextClass:"tabsRight",stMore:".tabsMore",stMoreLi:"ul.tabsMoreList"},init:function(B){if($.History){$.History.init("#container")}var A=this;$.extend(this._op,B);this.componentBox=$("#"+this._op.id);this._tabBox=this.componentBox.find(this._op.stTabBox);this._panelBox=this.componentBox.find(this._op.stPanelBox);this._prevBut=this.componentBox.find("."+this._op.prevClass);this._nextBut=this.componentBox.find("."+this._op.nextClass);this._moreBut=this.componentBox.find(this._op.stMore);this._moreBox=this.componentBox.find(this._op.stMoreLi);this._prevBut.click(function(C){A._scrollPrev()});this._nextBut.click(function(C){A._scrollNext()});this._moreBut.click(function(){A._moreBox.show();return false});$(document).click(function(){A._moreBox.hide()});this._contextmenu(this._tabBox);this._contextmenu(this._getTabs());this._init();this._ctrlScrollBut()},_init:function(){var A=this;this._getTabs().each(function(B){$(this).unbind("click").click(function(C){A._switchTab(B)});$(this).find(navTab._op.close$).unbind("click").click(function(){A._closeTab(B)})});this._getMoreLi().each(function(B){$(this).find(">a").unbind("click").click(function(C){A._switchTab(B)})});this._switchTab(this._currentIndex)},_contextmenu:function(A){var B=this;A.contextMenu("navTabCM",{bindings:{reload:function(D,C){var E=D.attr("tabid");if(E=="Authorization Manage"||E=="机构管理"){B.clearProtreeAttr()}B._reload(D,true)},closeCurrent:function(D,C){var E=D.attr("tabid");if(E){B.closeTab(E)}else{B.closeCurrentTab()}},closeOther:function(E,D){var F=E.attr("tabid");if(F!="Authorization Manage"&&F!="机构管理"){B.clearProtreeAttr()}var C=B._indexTabId(E.attr("tabid"));B._closeOtherTab(C>0?C:B._currentIndex)},closeAll:function(D,C){B.clearProtreeAttr();B.closeAllTab()}},ctrSub:function(G,F){var C=F.find("[rel='reload']");var I=F.find("[rel='closeCurrent']");var E=F.find("[rel='closeOther']");var D=F.find("[rel='closeAll']");var H=B._getTabs();if(H.size()<2){I.addClass("disabled");E.addClass("disabled");D.addClass("disabled")}if(B._currentIndex==0||G.attr("tabid")==B._op.mainTabId){I.addClass("disabled");C.addClass("disabled")}else{if(H.size()==2){E.addClass("disabled")}}}})},_getTabs:function(){return this._tabBox.find("> li")},_getPanels:function(){return this._panelBox.find("> div")},_getMoreLi:function(){return this._moreBox.find("> li")},_getTab:function(A){var B=this._indexTabId(A);if(B>=0){return this._getTabs().eq(B)}},getPanel:function(A){var B=this._indexTabId(A);if(B>=0){return this._getPanels().eq(B)}},_getTabsW:function(A,B){return this._tabsW(this._getTabs().slice(A,B))},_tabsW:function(A){var B=0;A.each(function(){B+=$(this).outerWidth(true)});return B},_indexTabId:function(A){if(!A){return -1}var B=-1;this._getTabs().each(function(C){if($(this).attr("tabid")==A){B=C;return}});return B},_getLeft:function(){return this._tabBox.position().left},_getScrollBarW:function(){return this.componentBox.width()-55},_visibleStart:function(){var B=this._getLeft(),C=0;var D=this._getTabs();for(var A=0;A<D.size();A++){if(C+B>=0){return A}C+=D.eq(A).outerWidth(true)}return 0},_visibleEnd:function(){var B=this._getLeft(),C=0;var D=this._getTabs();for(var A=0;A<D.size();A++){C+=D.eq(A).outerWidth(true);if(C+B>this._getScrollBarW()){return A}}return D.size()},_scrollPrev:function(){var A=this._visibleStart();if(A>0){this._scrollTab(-this._getTabsW(0,A-1))}},_scrollNext:function(){var A=this._visibleEnd();if(A<this._getTabs().size()){this._scrollTab(-this._getTabsW(0,A+1)+this._getScrollBarW())}},_scrollTab:function(A,C){var B=this;this._tabBox.animate({left:A+"px"},200,function(){B._ctrlScrollBut()})},_scrollCurrent:function(){var A=this._tabsW(this._getTabs());if(A<=this._getScrollBarW()){this._scrollTab(0)}else{if(this._getLeft()<this._getScrollBarW()-A){this._scrollTab(this._getScrollBarW()-A)}else{if(this._currentIndex<this._visibleStart()){this._scrollTab(-this._getTabsW(0,this._currentIndex))}else{if(this._currentIndex>=this._visibleEnd()){this._scrollTab(this._getScrollBarW()-this._getTabs().eq(this._currentIndex).outerWidth(true)-this._getTabsW(0,this._currentIndex))}}}}},_ctrlScrollBut:function(){var A=this._tabsW(this._getTabs());if(this._getScrollBarW()>A){this._prevBut.hide();this._nextBut.hide();this._tabBox.parent().removeClass("tabsPageHeaderMargin")}else{this._prevBut.show().removeClass("tabsLeftDisabled");this._nextBut.show().removeClass("tabsRightDisabled");this._tabBox.parent().addClass("tabsPageHeaderMargin");if(this._getLeft()>=0){this._prevBut.addClass("tabsLeftDisabled")}else{if(this._getLeft()<=this._getScrollBarW()-A){this._nextBut.addClass("tabsRightDisabled")}}}},_switchTab:function(B){var A=this._getTabs().removeClass("selected").eq(B).addClass("selected");this._getPanels().hide().eq(B).show();this._getMoreLi().removeClass("selected").eq(B).addClass("selected");this._currentIndex=B;this._scrollCurrent();this._reload(A)},_closeTab:function(C,A){Timer.cancel(this._getTabs().eq(C).attr("tabId"));if(global_ws){global_ws.close();global_ws=null}if(this._getTabs().eq(C).attr("tabId")=="Authorization Manage"||this._getTabs().eq(C).attr("tabId")=="机构管理"){this.clearProtreeAttr()}this._getTabs().eq(C).remove();this._getPanels().eq(C).trigger(DWZ.eventType.pageClear).remove();this._getMoreLi().eq(C).remove();if(this._currentIndex>=C){this._currentIndex--}if(A){var B=this._indexTabId(A);if(B>0){this._currentIndex=B}}this._init();this._scrollCurrent();this._reload(this._getTabs().eq(this._currentIndex))},closeTab:function(A){var B=this._indexTabId(A);if(B>0){this._closeTab(B)}},closeCurrentTab:function(A){if(this._currentIndex>0){this._closeTab(this._currentIndex,A)}},closeAllTab:function(){var A=this._getTabs().filter(":gt(0)").remove();A.each(function(){Timer.cancel($(this).attr("tabId"));if(global_ws){global_ws.close();global_ws=null}});this._getPanels().filter(":gt(0)").trigger(DWZ.eventType.pageClear).remove();this._getMoreLi().filter(":gt(0)").remove();this._currentIndex=0;this._init();this._scrollCurrent()},_closeOtherTab:function(C){C=C||this._currentIndex;if(C>0){var B=":eq("+C+")";var A=this._getTabs().not(B).filter(":gt(0)").remove();A.each(function(){Timer.cancel($(this).attr("tabId"));if(global_ws){global_ws.close();global_ws=null}});this._getPanels().not(B).filter(":gt(0)").trigger(DWZ.eventType.pageClear).remove();this._getMoreLi().not(B).filter(":gt(0)").remove();this._currentIndex=1;this._init();this._scrollCurrent()}else{this.closeAllTab()}},_loadUrlCallback:function(A){A.find("[layoutH]").layoutH();A.find(":button.close").click(function(){navTab.closeCurrentTab()})},_reload:function(D,E){E=E||D.data("reloadFlag");var B=D.attr("url");if(E&&B){Timer.cancel(D.attr("tabid"));if(global_ws){global_ws.close();global_ws=null}D.data("reloadFlag",null);var A=this.getPanel(D.attr("tabid"));if(D.hasClass("external")){navTab.openExternal(B,A)}else{var C=$("#pagerForm",A);var F=C.size()>0?C.serializeArray():{};A.loadUrl(B,F,function(){navTab._loadUrlCallback(A)})}}},reloadFlag:function(A){var B=this._getTab(A);if(B){if(this._indexTabId(A)==this._currentIndex){this._reload(B,true)}else{B.data("reloadFlag",1)}}},reload:function(B,D){var C=$.extend({data:{},navTabId:"",callback:null},D);var E=this._currentIndex;var A=C.navTabId?this._getTab(C.navTabId):this._getTabs().eq(this._currentIndex);var G=C.navTabId?this.getPanel(C.navTabId):this._getPanels().eq(this._currentIndex);Timer.cancel(A.attr("tabid"));if(global_ws){global_ws.close();global_ws=null}if(G){if(!B){B=A.attr("url")}if(B){if(A.hasClass("external")){navTab.openExternal(B,G)}else{if($.isEmptyObject(C.data)){var F=$("#pagerForm",G);C.data=F.size()>0?F.serializeArray():{}}G.ajaxUrl({type:"POST",url:B,data:C.data,callback:function(H){navTab._loadUrlCallback(G);if($.isFunction(C.callback)){C.callback(H)}}})}}}},getCurrentPanel:function(){return this._getPanels().eq(this._currentIndex)},checkTimeout:function(){var A=DWZ.jsonEval(this.getCurrentPanel().html());if(A&&A.statusCode==DWZ.statusCode.timeout){this.closeCurrentTab()}},openExternal:function(B,A){var C=navTab._panelBox.height();A.html(DWZ.frag["externalFrag"].replaceAll("{url}",B).replaceAll("{height}",C+"px"))},openTab:function(B,I,G){var H=$.extend({title:"New Tab",data:{},fresh:true,external:false},G);var E=this._indexTabId(B);if(E>=0){Timer.cancel(B);if(global_ws){global_ws.close();global_ws=null}var D=this._getTabs().eq(E);var J=D.attr("tabid")==this._op.mainTabId?"> span > span":"> span";D.find(">a").attr("title",H.title).find(J).text(H.title);var C=this._getPanels().eq(E);if(H.fresh||D.attr("url")!=I){D.attr("url",I);if(H.external||I.isExternalUrl()){D.addClass("external");navTab.openExternal(I,C)}else{D.removeClass("external");C.ajaxUrl({type:"GET",url:I,data:H.data,callback:function(){navTab._loadUrlCallback(C)}})}}this._currentIndex=E}else{var A='<li tabid="#tabid#"><a href="javascript:" title="#title#"><span>#title#</span></a><a href="javascript:;" class="close">close</a></li>';this._tabBox.append(A.replaceAll("#tabid#",B).replaceAll("#title#",H.title));this._panelBox.append('<div class="page unitBox"></div>');this._moreBox.append('<li><a href="javascript:" title="#title#">#title#</a></li>'.replaceAll("#title#",H.title));var F=this._getTabs();var D=F.filter(":last");var C=this._getPanels().filter(":last");if(H.external||I.isExternalUrl()){D.addClass("external");navTab.openExternal(I,C)}else{D.removeClass("external");C.ajaxUrl({type:"GET",url:I,data:H.data,callback:function(){navTab._loadUrlCallback(C)}})}if($.History){setTimeout(function(){$.History.addHistory(B,function(L){var K=navTab._indexTabId(L);if(K>=0){navTab._switchTab(K)}},B)},10)}this._currentIndex=F.size()-1;this._contextmenu(F.filter(":last").hoverClass("hover"));Timer.createPool(B)}this._init();this._scrollCurrent();this._getTabs().eq(this._currentIndex).attr("url",I)},openTab_cover:function(B,I,G){var H=$.extend({title:"New Tab",data:{},fresh:true,external:false},G);var E=this._indexTabId(B);if(E>=0){Timer.cancel(B);if(global_ws){global_ws.close();global_ws=null}var D=this._getTabs().eq(E);var J=D.attr("tabid")==this._op.mainTabId?"> span > span":"> span";D.find(">a").attr("title",H.title).find(J).text(H.title);var C=this._getPanels().eq(E);if(H.fresh||D.attr("url")!=I){D.attr("url",I);if(H.external||I.isExternalUrl()){D.addClass("external");navTab.openExternal(I,C)}else{D.removeClass("external");C.ajaxUrl_cover({type:"GET",url:I,data:H.data,callback:function(){navTab._loadUrlCallback(C)}})}}this._currentIndex=E}else{var A='<li tabid="#tabid#"><a href="javascript:" title="#title#" class="#tabid#"><span>#title#</span></a><a href="javascript:;" class="close">close</a></li>';this._tabBox.append(A.replaceAll("#tabid#",B).replaceAll("#title#",H.title));this._panelBox.append('<div class="page unitBox"></div>');this._moreBox.append('<li><a href="javascript:" title="#title#">#title#</a></li>'.replaceAll("#title#",H.title));var F=this._getTabs();var D=F.filter(":last");var C=this._getPanels().filter(":last");if(H.external||I.isExternalUrl()){D.addClass("external");navTab.openExternal(I,C)}else{D.removeClass("external");C.ajaxUrl_cover({type:"GET",url:I,data:H.data,callback:function(){navTab._loadUrlCallback(C)}})}if($.History){setTimeout(function(){$.History.addHistory(B,function(L){var K=navTab._indexTabId(L);if(K>=0){navTab._switchTab(K)}},B)},10)}this._currentIndex=F.size()-1;this._contextmenu(F.filter(":last").hoverClass("hover"));Timer.createPool(B)}this._init();this._scrollCurrent();this._getTabs().eq(this._currentIndex).attr("url",I)},clearProtreeAttr:function(){if($("#project_tree_htmlVal")){$("#project_tree_htmlVal").val("")}if($("#project_target_url")){$("#project_target_url").val("")}if($("#project_tree_li_id")){$("#project_tree_li_id").val("")}if($("#project_tree_li_id_old")){$("#project_tree_li_id_old").val("")}}};